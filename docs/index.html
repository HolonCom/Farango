<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!--
      The index parameters will be replaced with the
      document title extracted from the <h1> element or
      file name, if there is no <h1> heading
    -->
    <title>index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="style.css" />
    <script src="tips.js" type="text/javascript"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <!-- navbar items, navbar burger... -->
      </div>
    </nav>
    <div class="container">
      <section class="section">
  <div class="container">
    <img src="logo.svg" />
    <h1 class="title">Farango</h1>
    <h2 class="subtitle">
      A native F# client for <a href="https://www.arangodb.com/">ArangoDB</a>
    </h2>
  </div>
</section>
<section class="hero is-light">
  <div class="hero-body">
    <div class="container">
      <p>
        It was developed to fulfill three requirements.
      </p>
      <ol>
        <li>We prefer a bespoke idiomatic F# client over MacGyvering C# libraries.</li>
        <li>We want to leverage async to keep our applications non-blocking. That includes using AsyncSeq to return results as they become available.</li>
        <li>As developers, we don't want to be pigeonholed into receiving results in a given construct (Maps or Dictionaries) or with a given libary (Newtonsoft or Chiron.)
        We leave it up to client users how they want to parse results.</li>
      </ol>
      <p>
        That being said, Farango is currently a library of convenience.
        We implement features as we need them.
        Currently, that means that you can CRUD a document as well as query the database.
      </p>
      <p>
        We are, of course, open to community involvement.
      </p>
      <p>
       <em>Pro tip</em> Use <code>paket generate-load-scripts</code> to avoid manually loading all of Farango's dependencies in your .fsx files
      </p>
    </div>
  </div>
</section>
<h3>Connections</h3>
<p>We use dependency injection and include a Connection parameter in every database call.
This makes it easier to test the library as well as any implementation thereof.
It also allows you to create multiple connections (to multiple databases or even Arango instances.)</p>
<p>Connections are made asynchronously and return a <code>Result&lt;Connection, string&gt;</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#load</span> <span class="s">&quot;../Farango/Farango.Connection.fs&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Farango</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">Connection</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">connection</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="f">connect</span> <span class="s">&quot;http[s]://[username]:[password]@[host]:[port]/[database]&quot;</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 6)" onmouseover="showTip(event, 'fs6', 6)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<h3>Results</h3>
<p>Results to all commands and queries are given as JSON strings wrapped in a result.
If the result is a single document it will have the form <code>Result&lt;string, string&gt;</code>.
If the result is a list of documents it will have the form <code>Result&lt;string list, string&gt;</code>.
<code>getDocumentCount</code> returns <code>Result&lt;int, string&gt;</code> because, you know, that makes sense.</p>
<h3>Queries</h3>
<p>Queries are given a Connection, query, and optional Map of bindVars, and an optional batchSize.
Queries return all results at once even if the background requests are batched as per batchSize.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#load</span> <span class="s">&quot;../Farango/Farango.Queries.fs&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 7)" onmouseover="showTip(event, 'fs1', 7)" class="i">Farango</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">Queries</span>

<span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 10)" onmouseover="showTip(event, 'fs3', 10)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 11)" onmouseover="showTip(event, 'fs3', 11)" class="i">connection</span> <span class="k">-&gt;</span>

    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs9', 12)" onmouseover="showTip(event, 'fs9', 12)" class="i">query</span> <span onmouseout="hideTip(event, 'fs3', 13)" onmouseover="showTip(event, 'fs3', 13)" class="i">connection</span> <span class="s">&quot;FOR u IN users RETURN u&quot;</span> <span onmouseout="hideTip(event, 'fs10', 14)" onmouseover="showTip(event, 'fs10', 14)" class="i">None</span> (<span onmouseout="hideTip(event, 'fs11', 15)" onmouseover="showTip(event, 'fs11', 15)" class="i">Some</span> <span class="n">100</span>)

  | <span class="i">Error</span> <span class="i">error</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="i">Error</span> <span class="i">error</span>
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 16)" onmouseover="showTip(event, 'fs5', 16)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 17)" onmouseover="showTip(event, 'fs6', 17)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>bindVars allow you to inject variables into queries in a safe manner.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#load</span> <span class="s">&quot;../Farango/Farango.Queries.fs&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 18)" onmouseover="showTip(event, 'fs1', 18)" class="i">Farango</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 19)" onmouseover="showTip(event, 'fs7', 19)" class="i">Queries</span>

<span onmouseout="hideTip(event, 'fs8', 20)" onmouseover="showTip(event, 'fs8', 20)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 21)" onmouseover="showTip(event, 'fs3', 21)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 22)" onmouseover="showTip(event, 'fs3', 22)" class="i">connection</span> <span class="k">-&gt;</span>

    <span class="k">let</span> <span class="i">bindVars</span> <span class="o">=</span>
      <span onmouseout="hideTip(event, 'fs12', 23)" onmouseover="showTip(event, 'fs12', 23)" class="i">Map</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 24)" onmouseover="showTip(event, 'fs13', 24)" class="i">empty</span><span class="o">.</span>
        <span class="i">Add</span>(<span class="s">&quot;key&quot;</span>, (<span onmouseout="hideTip(event, 'fs14', 25)" onmouseover="showTip(event, 'fs14', 25)" class="i">box</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs15', 26)" onmouseover="showTip(event, 'fs15', 26)" class="i">string</span><span class="o">&gt;</span> <span class="s">&quot;12345&quot;</span>))

    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs9', 27)" onmouseover="showTip(event, 'fs9', 27)" class="i">query</span> <span onmouseout="hideTip(event, 'fs3', 28)" onmouseover="showTip(event, 'fs3', 28)" class="i">connection</span> <span class="s">&quot;FOR u IN users FILTER u._key == @key RETURN u&quot;</span> (<span onmouseout="hideTip(event, 'fs11', 29)" onmouseover="showTip(event, 'fs11', 29)" class="i">Some</span> <span class="i">bindVars</span>) (<span onmouseout="hideTip(event, 'fs11', 30)" onmouseover="showTip(event, 'fs11', 30)" class="i">Some</span> <span class="n">100</span>)

  | <span class="i">Error</span> <span class="i">error</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="i">Error</span> <span class="i">error</span>
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 31)" onmouseover="showTip(event, 'fs5', 31)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 32)" onmouseover="showTip(event, 'fs6', 32)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<h3>Query Sequences</h3>
<p>You can also use query results as a sequence.
They are also given a connection, query, an optional Map of bindVars, and an optional batchSize like a regular query.
You will need to use the <a href="https://fsprojects.github.io/FSharp.Control.AsyncSeq/library/AsyncSeq.html">AsyncSeq</a> library to manipulate the sequence.
Here, batchSize will determine how many results are returned in each iteration of the sequence.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;../packages/FSharp.Control.AsyncSeq/lib/net45/FSharp.Control.AsyncSeq.dll&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs16', 33)" onmouseover="showTip(event, 'fs16', 33)" class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs17', 34)" onmouseover="showTip(event, 'fs17', 34)" class="i">Control</span>

<span onmouseout="hideTip(event, 'fs8', 35)" onmouseover="showTip(event, 'fs8', 35)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 36)" onmouseover="showTip(event, 'fs3', 36)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 37)" onmouseover="showTip(event, 'fs3', 37)" class="i">connection</span> <span class="k">-&gt;</span>

    <span onmouseout="hideTip(event, 'fs18', 38)" onmouseover="showTip(event, 'fs18', 38)" class="i">querySequence</span> <span onmouseout="hideTip(event, 'fs3', 39)" onmouseover="showTip(event, 'fs3', 39)" class="i">connection</span> <span class="s">&quot;FOR u IN users RETURN u&quot;</span> <span onmouseout="hideTip(event, 'fs10', 40)" onmouseover="showTip(event, 'fs10', 40)" class="i">None</span> (<span onmouseout="hideTip(event, 'fs11', 41)" onmouseover="showTip(event, 'fs11', 41)" class="i">Some</span> <span class="n">100</span>)
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs19', 42)" onmouseover="showTip(event, 'fs19', 42)" class="i">AsyncSeq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 43)" onmouseover="showTip(event, 'fs20', 43)" class="i">iter</span> (<span onmouseout="hideTip(event, 'fs21', 44)" onmouseover="showTip(event, 'fs21', 44)" class="i">printfn</span> <span class="s">&quot;</span><span class="e">\n</span><span class="s">%A</span><span class="e">\n</span><span class="s">&quot;</span>)
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 45)" onmouseover="showTip(event, 'fs5', 45)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs22', 46)" onmouseover="showTip(event, 'fs22', 46)" class="i">Start</span>

  | _ <span class="k">-&gt;</span> ()
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 47)" onmouseover="showTip(event, 'fs5', 47)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 48)" onmouseover="showTip(event, 'fs6', 48)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<h3>Documents</h3>
<p>You can CRUD documents by passing a serialized JSON string in as the document.
For example, if we wanted to create, update, replace, and then delete a user from the users collection.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#load</span> <span class="s">&quot;../Farango/Farango.Documents.fs&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 49)" onmouseover="showTip(event, 'fs1', 49)" class="i">Farango</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 50)" onmouseover="showTip(event, 'fs23', 50)" class="i">Documents</span>

<span onmouseout="hideTip(event, 'fs8', 51)" onmouseover="showTip(event, 'fs8', 51)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 52)" onmouseover="showTip(event, 'fs3', 52)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 53)" onmouseover="showTip(event, 'fs3', 53)" class="i">connection</span> <span class="k">-&gt;</span>
    
    <span class="k">let!</span> <span class="i">createdDocument</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs24', 54)" onmouseover="showTip(event, 'fs24', 54)" class="i">createDocument</span> <span onmouseout="hideTip(event, 'fs3', 55)" onmouseover="showTip(event, 'fs3', 55)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span class="s">&quot;{</span><span class="e">\&quot;</span><span class="s">_key</span><span class="e">\&quot;</span><span class="s">:</span><span class="e">\&quot;</span><span class="s">12345</span><span class="e">\&quot;</span><span class="s">}&quot;</span>

    <span class="k">let!</span> <span class="i">document</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs25', 56)" onmouseover="showTip(event, 'fs25', 56)" class="i">getDocument</span> <span onmouseout="hideTip(event, 'fs3', 57)" onmouseover="showTip(event, 'fs3', 57)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span class="s">&quot;12345&quot;</span>

    <span class="k">let!</span> <span class="i">updatedDocument</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs26', 58)" onmouseover="showTip(event, 'fs26', 58)" class="i">updateDocument</span> <span onmouseout="hideTip(event, 'fs3', 59)" onmouseover="showTip(event, 'fs3', 59)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span class="s">&quot;12345&quot;</span> <span class="s">&quot;{</span><span class="e">\&quot;</span><span class="s">username</span><span class="e">\&quot;</span><span class="s">:</span><span class="e">\&quot;</span><span class="s">name</span><span class="e">\&quot;</span><span class="s">}&quot;</span>

    <span class="k">let!</span> <span class="i">replacedDocument</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 60)" onmouseover="showTip(event, 'fs27', 60)" class="i">replaceDocument</span> <span onmouseout="hideTip(event, 'fs3', 61)" onmouseover="showTip(event, 'fs3', 61)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span class="s">&quot;12345&quot;</span> <span class="s">&quot;{</span><span class="e">\&quot;</span><span class="s">username</span><span class="e">\&quot;</span><span class="s">:</span><span class="e">\&quot;</span><span class="s">user</span><span class="e">\&quot;</span><span class="s">,</span><span class="e">\&quot;</span><span class="s">password</span><span class="e">\&quot;</span><span class="s">:</span><span class="e">\&quot;</span><span class="s">pass</span><span class="e">\&quot;</span><span class="s">}&quot;</span>

    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs28', 62)" onmouseover="showTip(event, 'fs28', 62)" class="i">deleteDocument</span> <span onmouseout="hideTip(event, 'fs3', 63)" onmouseover="showTip(event, 'fs3', 63)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span class="s">&quot;12345&quot;</span>

  | <span class="i">Error</span> <span class="i">error</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="i">Error</span> <span class="i">error</span>
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 64)" onmouseover="showTip(event, 'fs5', 64)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 65)" onmouseover="showTip(event, 'fs6', 65)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>You can create multiple documents using <code>createDocuments</code>.
Just pass in a serialized JSON string representing an array of documents.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs8', 66)" onmouseover="showTip(event, 'fs8', 66)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 67)" onmouseover="showTip(event, 'fs3', 67)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 68)" onmouseover="showTip(event, 'fs3', 68)" class="i">connection</span> <span class="k">-&gt;</span>
    
    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs29', 69)" onmouseover="showTip(event, 'fs29', 69)" class="i">createDocuments</span> <span onmouseout="hideTip(event, 'fs3', 70)" onmouseover="showTip(event, 'fs3', 70)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span class="s">&quot;[{</span><span class="e">\&quot;</span><span class="s">username</span><span class="e">\&quot;</span><span class="s">:</span><span class="e">\&quot;</span><span class="s">user</span><span class="e">\&quot;</span><span class="s">},{</span><span class="e">\&quot;</span><span class="s">username</span><span class="e">\&quot;</span><span class="s">:</span><span class="e">\&quot;</span><span class="s">name</span><span class="e">\&quot;</span><span class="s">}]&quot;</span>

  | <span class="i">Error</span> <span class="i">error</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="i">Error</span> <span class="i">error</span>
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 71)" onmouseover="showTip(event, 'fs5', 71)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 72)" onmouseover="showTip(event, 'fs6', 72)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<h3>Collections</h3>
<p>You can do basic queries on collections.
<code>allDocuments</code> takes a connection, collection, optional skip, optional limit, and optional batchSize.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#load</span> <span class="s">&quot;../Farango/Farango.Collections.fs&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 73)" onmouseover="showTip(event, 'fs1', 73)" class="i">Farango</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 74)" onmouseover="showTip(event, 'fs30', 74)" class="i">Collections</span>

<span onmouseout="hideTip(event, 'fs8', 75)" onmouseover="showTip(event, 'fs8', 75)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 76)" onmouseover="showTip(event, 'fs3', 76)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 77)" onmouseover="showTip(event, 'fs3', 77)" class="i">connection</span> <span class="k">-&gt;</span>

    <span class="k">return!</span> <span onmouseout="hideTip(event, 'fs31', 78)" onmouseover="showTip(event, 'fs31', 78)" class="i">allDocuments</span> <span onmouseout="hideTip(event, 'fs3', 79)" onmouseover="showTip(event, 'fs3', 79)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span onmouseout="hideTip(event, 'fs10', 80)" onmouseover="showTip(event, 'fs10', 80)" class="i">None</span> <span onmouseout="hideTip(event, 'fs10', 81)" onmouseover="showTip(event, 'fs10', 81)" class="i">None</span> <span onmouseout="hideTip(event, 'fs10', 82)" onmouseover="showTip(event, 'fs10', 82)" class="i">None</span>

  | <span class="i">Error</span> <span class="i">error</span> <span class="k">-&gt;</span> <span class="k">return</span> <span class="i">Error</span> <span class="i">error</span>
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 83)" onmouseover="showTip(event, 'fs5', 83)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 84)" onmouseover="showTip(event, 'fs6', 84)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>Of course, you can also get all documents as a sequence.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs8', 85)" onmouseover="showTip(event, 'fs8', 85)" class="i">async</span> {
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 86)" onmouseover="showTip(event, 'fs3', 86)" class="i">connection</span> <span class="k">with</span>
  | <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 87)" onmouseover="showTip(event, 'fs3', 87)" class="i">connection</span> <span class="k">-&gt;</span>

    <span onmouseout="hideTip(event, 'fs32', 88)" onmouseover="showTip(event, 'fs32', 88)" class="i">allDocumentsSequence</span> <span onmouseout="hideTip(event, 'fs3', 89)" onmouseover="showTip(event, 'fs3', 89)" class="i">connection</span> <span class="s">&quot;users&quot;</span> <span onmouseout="hideTip(event, 'fs10', 90)" onmouseover="showTip(event, 'fs10', 90)" class="i">None</span> <span onmouseout="hideTip(event, 'fs10', 91)" onmouseover="showTip(event, 'fs10', 91)" class="i">None</span> <span onmouseout="hideTip(event, 'fs10', 92)" onmouseover="showTip(event, 'fs10', 92)" class="i">None</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs19', 93)" onmouseover="showTip(event, 'fs19', 93)" class="i">AsyncSeq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 94)" onmouseover="showTip(event, 'fs20', 94)" class="i">iter</span> (<span onmouseout="hideTip(event, 'fs21', 95)" onmouseover="showTip(event, 'fs21', 95)" class="i">printfn</span> <span class="s">&quot;</span><span class="e">\n</span><span class="s">%A</span><span class="e">\n</span><span class="s">&quot;</span>)
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 96)" onmouseover="showTip(event, 'fs5', 96)" class="i">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs22', 97)" onmouseover="showTip(event, 'fs22', 97)" class="i">Start</span>

  | _ <span class="k">-&gt;</span> ()
} <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs5', 98)" onmouseover="showTip(event, 'fs5', 98)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 99)" onmouseover="showTip(event, 'fs6', 99)" class="f">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<h3>Change data capture</h3>
<p>You can poll an Arango instance and be notified when documents are inserted/updated or deleted.
A Subscriber is a Change (InsertUpdate | Delete), a Collection (string option), and a function from Message -&gt; unit.
Messages have the same Change and Collection fields as Subscribers.
Messages also have Data which is a JSON string.
This will hold the document in question.
You can parse it however you wish.</p>
<p>You can subscribe to a single collection with Collection = Some "collection" or subscribe to all collections with Collection = None.
You'll see below that we are listening for InsertUpdate events on the users collection and Delete events on every collection in the database.</p>
<p>To start polling just pass a Connection and a list of Subscribers to the start function.</p>
<p>We use mutually recursive async functions to poll the database.
A simple backoff is used and a second is added between polls.
Once new data is found, the backoff resets to zero.
There is a maximum backoff time of 10 seconds.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#load</span> <span class="s">&quot;../Farango/Farango.Cdc.fs&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 100)" onmouseover="showTip(event, 'fs1', 100)" class="i">Farango</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs33', 101)" onmouseover="showTip(event, 'fs33', 101)" class="i">Cdc</span>

<span class="k">match</span> <span onmouseout="hideTip(event, 'fs3', 102)" onmouseover="showTip(event, 'fs3', 102)" class="i">connection</span> <span class="k">with</span>
| <span class="i">Ok</span> <span onmouseout="hideTip(event, 'fs3', 103)" onmouseover="showTip(event, 'fs3', 103)" class="i">connection</span> <span class="k">-&gt;</span>

  <span class="k">let</span> <span class="i">sub1</span> <span class="o">=</span> { <span onmouseout="hideTip(event, 'fs34', 104)" onmouseover="showTip(event, 'fs34', 104)" class="i">Change</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs35', 105)" onmouseover="showTip(event, 'fs35', 105)" class="i">InsertUpdate</span>; <span class="i">Collection</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 106)" onmouseover="showTip(event, 'fs11', 106)" class="i">Some</span> <span class="s">&quot;users&quot;</span>; <span class="i">Fn</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs21', 107)" onmouseover="showTip(event, 'fs21', 107)" class="i">printfn</span> <span class="s">&quot;</span><span class="e">\n</span><span class="s">%A</span><span class="e">\n</span><span class="s">&quot;</span> }
  <span class="k">let</span> <span class="i">sub2</span> <span class="o">=</span> { <span onmouseout="hideTip(event, 'fs34', 108)" onmouseover="showTip(event, 'fs34', 108)" class="i">Change</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs36', 109)" onmouseover="showTip(event, 'fs36', 109)" class="i">Delete</span>; <span class="i">Collection</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs10', 110)" onmouseover="showTip(event, 'fs10', 110)" class="i">None</span>; <span class="i">Fn</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs21', 111)" onmouseover="showTip(event, 'fs21', 111)" class="i">printfn</span> <span class="s">&quot;</span><span class="e">\n</span><span class="s">%A</span><span class="e">\n</span><span class="s">&quot;</span> }
  <span onmouseout="hideTip(event, 'fs37', 112)" onmouseover="showTip(event, 'fs37', 112)" class="i">start</span> <span onmouseout="hideTip(event, 'fs3', 113)" onmouseover="showTip(event, 'fs3', 113)" class="i">connection</span> [<span class="i">sub1</span>; <span class="i">sub2</span>]

| _ <span class="k">-&gt;</span> ()
</code></pre></td>
</tr>
</table>

      <div class="tip" id="fs1">namespace Farango</div>
<div class="tip" id="fs2">module Connection<br /><br />from Farango</div>
<div class="tip" id="fs3">val connection : obj<br /><br />Full name: Index.connection</div>
<div class="tip" id="fs4">val connect : uri:string -&gt; Async&lt;&#39;a&gt;<br /><br />Full name: Farango.Connection.connect</div>
<div class="tip" id="fs5">Multiple items<br />type Async<br />static member AsBeginEnd : computation:(&#39;Arg -&gt; Async&lt;&#39;T&gt;) -&gt; (&#39;Arg * AsyncCallback * obj -&gt; IAsyncResult) * (IAsyncResult -&gt; &#39;T) * (IAsyncResult -&gt; unit)<br />static member AwaitEvent : event:IEvent&lt;&#39;Del,&#39;T&gt; * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt; (requires delegate and &#39;Del :&gt; Delegate)<br />static member AwaitIAsyncResult : iar:IAsyncResult * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member AwaitTask : task:Task -&gt; Async&lt;unit&gt;<br />static member AwaitTask : task:Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;<br />static member AwaitWaitHandle : waitHandle:WaitHandle * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member CancelDefaultToken : unit -&gt; unit<br />static member Catch : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;Choice&lt;&#39;T,exn&gt;&gt;<br />static member FromBeginEnd : beginAction:(AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg:&#39;Arg1 * beginAction:(&#39;Arg1 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * beginAction:(&#39;Arg1 * &#39;Arg2 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * arg3:&#39;Arg3 * beginAction:(&#39;Arg1 * &#39;Arg2 * &#39;Arg3 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromContinuations : callback:((&#39;T -&gt; unit) * (exn -&gt; unit) * (OperationCanceledException -&gt; unit) -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Ignore : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;unit&gt;<br />static member OnCancel : interruption:(unit -&gt; unit) -&gt; Async&lt;IDisposable&gt;<br />static member Parallel : computations:seq&lt;Async&lt;&#39;T&gt;&gt; -&gt; Async&lt;&#39;T []&gt;<br />static member RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:CancellationToken -&gt; &#39;T<br />static member Sleep : millisecondsDueTime:int -&gt; Async&lt;unit&gt;<br />static member Start : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions * ?cancellationToken:CancellationToken -&gt; Task&lt;&#39;T&gt;<br />static member StartChild : computation:Async&lt;&#39;T&gt; * ?millisecondsTimeout:int -&gt; Async&lt;Async&lt;&#39;T&gt;&gt;<br />static member StartChildAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions -&gt; Async&lt;Task&lt;&#39;T&gt;&gt;<br />static member StartImmediate : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartWithContinuations : computation:Async&lt;&#39;T&gt; * continuation:(&#39;T -&gt; unit) * exceptionContinuation:(exn -&gt; unit) * cancellationContinuation:(OperationCanceledException -&gt; unit) * ?cancellationToken:CancellationToken -&gt; unit<br />static member SwitchToContext : syncContext:SynchronizationContext -&gt; Async&lt;unit&gt;<br />static member SwitchToNewThread : unit -&gt; Async&lt;unit&gt;<br />static member SwitchToThreadPool : unit -&gt; Async&lt;unit&gt;<br />static member TryCancelled : computation:Async&lt;&#39;T&gt; * compensation:(OperationCanceledException -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member CancellationToken : Async&lt;CancellationToken&gt;<br />static member DefaultCancellationToken : CancellationToken<br /><br />Full name: Microsoft.FSharp.Control.Async<br /><br />--------------------<br />type Async&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Async&lt;_&gt;</div>
<div class="tip" id="fs6">static member Async.RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:System.Threading.CancellationToken -&gt; &#39;T</div>
<div class="tip" id="fs7">module Queries<br /><br />from Farango</div>
<div class="tip" id="fs8">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs9">val query : connection:&#39;a -&gt; query:string -&gt; bindVars:Map&lt;string,obj&gt; option -&gt; batchSize:int option -&gt; Async&lt;&#39;b&gt;<br /><br />Full name: Farango.Queries.query</div>
<div class="tip" id="fs10">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs11">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs12">Multiple items<br />module Map<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type Map&lt;&#39;Key,&#39;Value (requires comparison)&gt; =<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IComparable<br />&#160;&#160;interface IEnumerable&lt;KeyValuePair&lt;&#39;Key,&#39;Value&gt;&gt;<br />&#160;&#160;interface ICollection&lt;KeyValuePair&lt;&#39;Key,&#39;Value&gt;&gt;<br />&#160;&#160;interface IDictionary&lt;&#39;Key,&#39;Value&gt;<br />&#160;&#160;new : elements:seq&lt;&#39;Key * &#39;Value&gt; -&gt; Map&lt;&#39;Key,&#39;Value&gt;<br />&#160;&#160;member Add : key:&#39;Key * value:&#39;Value -&gt; Map&lt;&#39;Key,&#39;Value&gt;<br />&#160;&#160;member ContainsKey : key:&#39;Key -&gt; bool<br />&#160;&#160;override Equals : obj -&gt; bool<br />&#160;&#160;member Remove : key:&#39;Key -&gt; Map&lt;&#39;Key,&#39;Value&gt;<br />&#160;&#160;...<br /><br />Full name: Microsoft.FSharp.Collections.Map&lt;_,_&gt;<br /><br />--------------------<br />new : elements:seq&lt;&#39;Key * &#39;Value&gt; -&gt; Map&lt;&#39;Key,&#39;Value&gt;</div>
<div class="tip" id="fs13">val empty&lt;&#39;Key,&#39;T (requires comparison)&gt; : Map&lt;&#39;Key,&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Collections.Map.empty</div>
<div class="tip" id="fs14">val box : value:&#39;T -&gt; obj<br /><br />Full name: Microsoft.FSharp.Core.Operators.box</div>
<div class="tip" id="fs15">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs16">Multiple items<br />namespace FSharp<br /><br />--------------------<br />namespace Microsoft.FSharp</div>
<div class="tip" id="fs17">Multiple items<br />namespace FSharp.Control<br /><br />--------------------<br />namespace Microsoft.FSharp.Control</div>
<div class="tip" id="fs18">val querySequence : connection:&#39;a -&gt; query:string -&gt; bindVars:Map&lt;string,obj&gt; option -&gt; batchSize:int option -&gt; AsyncSeq&lt;&#39;b&gt;<br /><br />Full name: Farango.Queries.querySequence</div>
<div class="tip" id="fs19">Multiple items<br />module AsyncSeq<br /><br />from FSharp.Control<br /><br />--------------------<br />type AsyncSeq&lt;&#39;T&gt; = IAsyncEnumerable&lt;&#39;T&gt;<br /><br />Full name: FSharp.Control.AsyncSeq&lt;_&gt;</div>
<div class="tip" id="fs20">val iter : action:(&#39;T -&gt; unit) -&gt; source:AsyncSeq&lt;&#39;T&gt; -&gt; Async&lt;unit&gt;<br /><br />Full name: FSharp.Control.AsyncSeq.iter</div>
<div class="tip" id="fs21">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs22">static member Async.Start : computation:Async&lt;unit&gt; * ?cancellationToken:System.Threading.CancellationToken -&gt; unit</div>
<div class="tip" id="fs23">module Documents<br /><br />from Farango</div>
<div class="tip" id="fs24">val createDocument : connection:&#39;a -&gt; collection:string -&gt; body:string -&gt; Async&lt;obj&gt;<br /><br />Full name: Farango.Documents.createDocument</div>
<div class="tip" id="fs25">val getDocument : connection:&#39;a -&gt; collection:string -&gt; key:string -&gt; Async&lt;obj&gt;<br /><br />Full name: Farango.Documents.getDocument</div>
<div class="tip" id="fs26">val updateDocument : connection:&#39;a -&gt; collection:string -&gt; key:string -&gt; body:string -&gt; Async&lt;obj&gt;<br /><br />Full name: Farango.Documents.updateDocument</div>
<div class="tip" id="fs27">val replaceDocument : connection:&#39;a -&gt; collection:string -&gt; key:string -&gt; body:string -&gt; Async&lt;obj&gt;<br /><br />Full name: Farango.Documents.replaceDocument</div>
<div class="tip" id="fs28">val deleteDocument : connection:&#39;a -&gt; collection:string -&gt; key:string -&gt; Async&lt;obj&gt;<br /><br />Full name: Farango.Documents.deleteDocument</div>
<div class="tip" id="fs29">val createDocuments : (&#39;a -&gt; string -&gt; string -&gt; Async&lt;obj&gt;)<br /><br />Full name: Farango.Documents.createDocuments</div>
<div class="tip" id="fs30">module Collections<br /><br />from Farango</div>
<div class="tip" id="fs31">val allDocuments : connection:&#39;a -&gt; collection:string -&gt; skip:int option -&gt; limit:int option -&gt; batchSize:int option -&gt; Async&lt;&#39;b&gt;<br /><br />Full name: Farango.Collections.allDocuments</div>
<div class="tip" id="fs32">val allDocumentsSequence : connection:&#39;a -&gt; collection:string -&gt; skip:int option -&gt; limit:int option -&gt; batchSize:int option -&gt; AsyncSeq&lt;&#39;b&gt;<br /><br />Full name: Farango.Collections.allDocumentsSequence</div>
<div class="tip" id="fs33">module Cdc<br /><br />from Farango</div>
<div class="tip" id="fs34">type Change =<br />&#160;&#160;| InsertUpdate<br />&#160;&#160;| Delete<br /><br />Full name: Farango.Cdc.Change</div>
<div class="tip" id="fs35">union case Change.InsertUpdate: Change</div>
<div class="tip" id="fs36">union case Change.Delete: Change</div>
<div class="tip" id="fs37">val start : connection:&#39;a -&gt; bus:Bus -&gt; unit<br /><br />Full name: Farango.Cdc.start</div>

    </div>
  </body>
</html>
